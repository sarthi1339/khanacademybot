const dispatcher = require('httpdispatcher');
const http       = require('http');
const https      = require('https');
const async      = require('async');
const url        = require('url');
const chalk      = require('chalk');
const botRunner  = require('./localBotRunner');
const utils      = require('./BotUtils');

const PORT = process.env.PORT || 8081;

process.on("uncaughtException", function (err) {
    console.error("Caught exception:", err, err.stack);
});

function handleRequest(request, response) {
    try {
        console.log('Request URL => ' + request.url);
        dispatcher.dispatch(request, response);
    } catch (err) {
        console.log('Error Occurred => ' + err);
        console.log(err.stack);
    }
}

var server;

dispatcher.onGet("/botcallback", function (req, res) {
    botRunner.setupContext().then(botenv => {
        var queryObject = url.parse(req.url, true).query;
        var event       = setupEvent(queryObject);
        var context     = botenv.botcontext;
        botRunner.executeFunction(context, event, res, botenv);
    });
});

dispatcher.onGet("/healthCheck", function (req, res) {
    res.end("SUCCESS");
})

dispatcher.onError(function (req, res) {
    res.writeHead(501);
    res.end("ERROR : Something went wrong check bot logs for more details.");
});

function setupEvent(queryObject) {
    var botevent = {};
    if (queryObject.httpevent) {
        var httpevent = JSON.parse(queryObject.httpevent);
        Object.keys(httpevent).map(function (key) {
            var val       = httpevent[key];
            botevent[key] = val;
        });
    } else {
        var userevent = queryObject;
        Object.keys(userevent).map(function (key) {
            var val = userevent[key];
            if (utils.isJson(val)) {
                val = utils.parseJson(val);
            }
            botevent[key] = val;
        });
        botevent.botname = userevent.botname;
        botevent.context = botevent['contextobj'];
        botevent.message = botevent['messageobj']['text'];
        botevent.sender  = botevent['senderobj'].channelid;
    }
    console.log('Bot event : \n' + JSON.stringify(botevent));
    return botevent;
}

exports.init = function () {
    server = http.createServer(handleRequest);
    server.listen(PORT, function () {
        console.debug(chalk.bold(`Server listening on: http://localhost:${PORT}`));
    });
};

